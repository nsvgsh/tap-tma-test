# План реализации: Развертывание на Vercel и Supabase

## 1. Архитектурный анализ

-   **Фронтенд**: Next.js приложение, размещенное в директории `web/`, будет развернуто на платформе Vercel.
-   **Бэкенд (API)**: API-логика реализована как Next.js API Routes (`web/src/app/(api)/...`). Vercel автоматически развернет их как Serverless Functions. Отдельные Supabase Edge Functions в проекте отсутствуют и их развертывание не требуется.
-   **База данных**: Будет использоваться PostgreSQL от Supabase. Схема и начальные данные будут настроены путем последовательного применения всех миграций из директории `supabase/migrations/`.
-   **Процесс**: План включает создание облачных ресурсов, настройку переменных окружения, миграцию базы данных, запуск развертывания и финальную проверку работоспособности.

## 2. Список задач

1.  **Настройка проекта Supabase**
    -   [ ] Создать новый проект в Supabase.
    -   [ ] Сохранить ключевые данные для доступа: `Project URL`, `Service Role Key`, `Anon/PUBLISHABLE Key`.

2.  **Настройка базы данных Supabase**
    -   [ ] (Шаг 0 для пустой БД) Применить базовую схему: открыть SQL Editor и выполнить `docs/db-schema.sql` целиком. Это создаст таблицы-скелет, ожидаемые миграциями.
    -   [ ] Затем последовательно выполнить все SQL-миграции из директории `supabase/migrations/` (от `001` до `005`). Это добавит функции, индексы, сиды и изменения политики.
    -   Примечание: ошибка вида `relation "level_events" does not exist` на `001_hotpath.sql` означает, что базовая схема не была применена. Сначала выполните `docs/db-schema.sql`, затем повторите миграции.

3.  **Настройка проекта Vercel**
    -   [ ] Создать новый проект в Vercel.
    -   [ ] Подключить репозиторий проекта к Vercel.
    -   [ ] В настройках проекта указать корневую директорию `web`.

4.  **Конфигурация переменных окружения**
    -   [ ] В настройках проекта Vercel добавить следующие переменные окружения:
        -   `DATABASE_URL` (обязателен): строка подключения к Supabase Postgres. В проде используйте pooler-строку (порт 6543) с `sslmode=require`.
        -   `NEXT_PUBLIC_SUPABASE_URL` (необязателен на текущей архитектуре): используется только если фронтенд напрямую инициализирует supabase-js (сейчас не используется).
        -   `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY` (необязателен на текущей архитектуре): публичный ключ Supabase для клиента; требуется только при использовании supabase-js в браузере (сейчас не используется).
        -   `SUPABASE_SERVICE_ROLE_KEY` (необязателен на текущей архитектуре): нужен для админ-операций через supabase-js или Edge Functions; сервер общается с БД напрямую через `pg`.
        -   `TELEGRAM_BOT_TOKEN` (необязателен на текущей архитектуре): потребуется при добавлении входа через Telegram.
        -   При необходимости клиентских фич: `NEXT_PUBLIC_LEADERBOARD_ACTIVE_WINDOW_DAYS`.

5.  **Запуск и проверка развертывания**
    -   [ ] Запустить процесс развертывания (deploy) в Vercel.
    -   [ ] После успешного завершения, провести дымовое тестирование (smoke testing) согласно `docs/deploy-pipeline.md` для проверки ключевых эндпоинтов.
    -   [ ] Выполнить тестовый прогон основного игрового цикла через Telegram-бота.

## 3. Согласованность переменных окружения (локально vs прод)

-   **Факт (локальная разработка)**
    -   Источник шаблона: `docs/env.example` (обновлено).
    -   Генерация файла: `web/scripts/setup-env.mjs` создаёт/синхронизирует `web/.env.local`.
    -   Используемые ключи (клиент):
        -   `NEXT_PUBLIC_SUPABASE_URL` (зарезервирован; сейчас не используется напрямую)
        -   `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY`  ← заменено с `NEXT_PUBLIC_SUPABASE_ANON_KEY` (зарезервирован; сейчас не используется напрямую)
        -   `NEXT_PUBLIC_DEV_TOKEN`
        -   `NEXT_PUBLIC_LEADERBOARD_ACTIVE_WINDOW_DAYS`
    -   Используемые ключи (сервер):
        -   `DATABASE_URL` (локальный Postgres)
        -   `DEV_TOKEN`

-   **Факт (продакшен / Vercel)**
    -   Хранилище значений: настройки проекта в Vercel (Environment Variables).
    -   Обязательные ключи для текущей архитектуры:
        -   `DATABASE_URL` — используем Pooler-строку Supabase (порт 6543, `sslmode=require`). Именно по ней Next.js API общается с БД через `pg`.
    -   Необязательные на текущей архитектуре (подключать при переходе на supabase-js/Edge Functions/Telegram login):
        -   `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `TELEGRAM_BOT_TOKEN`.
    -   Дополнительно по необходимости: `NEXT_PUBLIC_LEADERBOARD_ACTIVE_WINDOW_DAYS`.

-   **Примечания по совместимости**
    -   Архитектура сейчас использует прямое подключение `pg` из Route Handlers к Postgres; Supabase-клиент на фронтенде не используется, поэтому `NEXT_PUBLIC_SUPABASE_*` не требуются.
    -   При миграции на supabase-js (клиент/сервер) эти переменные станут обязательными.

## 4. Влияние на документацию

-   `docs/env.example` — исправлено имя ключа на `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY`.
-   Дополнительно: при первом успешном прод‑деплое добавить раздел в `docs/deploy-pipeline.md` с перечислением фактических прод‑переменных и их источников (без секретов).


